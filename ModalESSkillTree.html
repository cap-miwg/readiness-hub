<script type="text/babel">
// Recursive prerequisite tree component (shared with ModalESQualification)
// Displays the hierarchical structure of prerequisite qualifications
const PrereqTreeView = ({ node, memberQuals, member, dataService, depth, showSelf = true }) => {
  if (!node) return null;

  // Check if prerequisite is completed
  let hasPrereq = false;
  let displayName = node.name;

  // Special handling for Achievement 1 (Curry - ID '95') vs Level 1 (ID '96')
  // Seniors need Level 1, Cadets need Achievement 1
  const memberType = String(member?.Type || member?.TYPE || '').toUpperCase();
  const isCadet = memberType === 'CADET';
  const isSenior = !isCadet;

  if (node.achvID === '95' || node.achvID === '96') {
    // '95' = Achievement 1 (Curry) for cadets
    // '96' = Level 1 for seniors

    if (isSenior) {
      // For senior members, check Level 1 completion and display "Level 1"
      hasPrereq = member?.levelsProgress?.L1?.status === 'completed';
      displayName = 'Level 1';
    } else {
      // For cadets, check Achievement 1 and display "Achievement 1 (Curry)"
      if (dataService) {
        const rawData = dataService.rawData();
        hasPrereq = (rawData.esMbrAchievements || []).some(a =>
          a.CAPID === member?.CAPID &&
          a.AchvID === '95' &&
          String(a.Status || '').toUpperCase() === 'ACTIVE'
        );
      } else {
        hasPrereq = memberQuals?.some(q =>
          q.achvID === '95' && q.status === 'Active'
        );
      }
      displayName = 'Achievement 1 (Curry)';
    }
  } else {
    // Regular ES qualification check - use raw data from dataService if available
    // This ensures IS courses and other filtered achievements are still checked
    if (dataService) {
      const rawData = dataService.rawData();
      hasPrereq = (rawData.esMbrAchievements || []).some(a =>
        a.CAPID === member?.CAPID &&
        a.AchvID === node.achvID &&
        String(a.Status || '').toUpperCase() === 'ACTIVE'
      );
    } else {
      // Fallback to filtered qualifications if no dataService
      hasPrereq = memberQuals?.some(q =>
        q.achvID === node.achvID && q.status === 'Active'
      );
    }
  }

  const indentClass = depth > 0 ? 'ml-4 pl-3 border-l-2 border-slate-200' : '';

  // If showSelf is false, only render the prerequisites (skip the root node itself)
  if (!showSelf && depth === 0) {
    // Filter out duplicate Achievement 1/Level 1 entries (IDs '95' and '96' are equivalent)
    let filteredPrereqs = node.prerequisites || [];
    const hasAchv95 = filteredPrereqs.some(p => p.achvID === '95');
    const hasAchv96 = filteredPrereqs.some(p => p.achvID === '96');

    if (hasAchv95 && hasAchv96) {
      // Remove '96' (Level 1) and keep '95' (Achievement 1) - the display logic will handle member type
      filteredPrereqs = filteredPrereqs.filter(p => p.achvID !== '96');
    }

    return (
      <div>
        {filteredPrereqs.length > 0 ? (
          filteredPrereqs.map((prereq, idx) => (
            <PrereqTreeView
              key={idx}
              node={prereq}
              memberQuals={memberQuals}
              member={member}
              dataService={dataService}
              depth={0}
              showSelf={true}
            />
          ))
        ) : (
          <div className="text-sm text-slate-500 italic">
            No prerequisite qualifications required
          </div>
        )}
      </div>
    );
  }

  return (
    <div className={indentClass}>
      <div className={`flex items-start gap-2 py-1 ${depth > 0 ? 'text-xs' : 'text-sm'}`}>
        <div className="mt-0.5">
          {hasPrereq ? (
            <Icon name="CheckCircle2" className="w-4 h-4 text-emerald-600" />
          ) : (
            <Icon name="Circle" className="w-4 h-4 text-slate-300" />
          )}
        </div>
        <span className={hasPrereq ? 'text-emerald-700 font-medium' : 'text-slate-600'}>
          {displayName}
        </span>
      </div>

      {node.prerequisites && node.prerequisites.length > 0 && (() => {
        // Filter out duplicate Achievement 1/Level 1 entries (IDs '95' and '96' are equivalent)
        let filteredPrereqs = node.prerequisites;
        const hasAchv95 = filteredPrereqs.some(p => p.achvID === '95');
        const hasAchv96 = filteredPrereqs.some(p => p.achvID === '96');

        if (hasAchv95 && hasAchv96) {
          // Remove '96' (Level 1) and keep '95' (Achievement 1) - the display logic will handle member type
          filteredPrereqs = filteredPrereqs.filter(p => p.achvID !== '96');
        }

        return (
          <div className="mt-1">
            {filteredPrereqs.map((prereq, idx) => (
              <PrereqTreeView
                key={idx}
                node={prereq}
                memberQuals={memberQuals}
                member={member}
                dataService={dataService}
                depth={depth + 1}
                showSelf={true}
              />
            ))}
          </div>
        );
      })()}
    </div>
  );
};

// ES Qualification Tree Modal
// Shows visual skill tree of qualifications with prerequisites and eligibility
const ESQualificationTreeModal = ({ isOpen, onClose, member, dataService, allQualifications }) => {
  if (!isOpen || !member) return null;

  const [selectedQual, setSelectedQual] = React.useState(null);
  const [eligibilityMap, setEligibilityMap] = React.useState({});
  const [selectedQualTasks, setSelectedQualTasks] = React.useState([]);
  const [viewMode, setViewMode] = React.useState('progression'); // 'progression' or 'all'
  const [detailModalOpen, setDetailModalOpen] = React.useState(false);

  // Build eligibility map for all qualifications
  React.useEffect(() => {
    if (dataService && member && allQualifications) {
      const map = {};
      allQualifications.forEach(qual => {
        const eligibility = dataService.checkESQualificationEligibility(qual.AchvID || qual.achvID, member);
        map[qual.AchvID || qual.achvID] = eligibility;
      });
      setEligibilityMap(map);
    }
  }, [member, dataService, allQualifications]);

  // Load tasks when a qualification is selected
  React.useEffect(() => {
    if (selectedQual && dataService && member) {
      const achvID = selectedQual.AchvID || selectedQual.achvID;
      const tasks = dataService.getESAchievementTasks(achvID, member.CAPID);
      setSelectedQualTasks(tasks);
    } else {
      setSelectedQualTasks([]);
    }
  }, [selectedQual, dataService, member]);

  // Filter qualifications for the skill tree (show IS/ICS courses here, but exclude them from profile)
  // In skill tree, we want to show IS/ICS courses so members can see they've completed them
  const filteredQualifications = React.useMemo(() => {
    if (!allQualifications) return [];
    return allQualifications.filter(qual => {
      const achvID = qual.AchvID || qual.achvID;
      const functionalArea = qual.FunctionalArea || qual.functionalArea;

      // Create a modified exclusion set that doesn't include IS/ICS courses for skill tree
      const IS_ICS_COURSE_IDS = new Set([
        '176', '177', '178', '179', '180', '181', '267', '268', '270', '271', '272', '273'
      ]);

      // For skill tree, exclude everything EXCEPT IS/ICS courses
      const excludeAchvIDs = new Set([...ES_EXCLUDED_ACHIEVEMENT_IDS]);
      IS_ICS_COURSE_IDS.forEach(id => excludeAchvIDs.delete(id)); // Remove IS/ICS from exclusions

      if (excludeAchvIDs.has(achvID) || ES_EXCLUDED_FUNCTIONAL_AREAS.has(functionalArea)) {
        return false;
      }
      return true;
    });
  }, [allQualifications]);

  // Group qualifications by functional area
  const qualsByArea = React.useMemo(() => {
    if (!filteredQualifications) return {};

    const grouped = {};
    filteredQualifications.forEach(qual => {
      const area = qual.FunctionalArea || qual.functionalArea || 'Other';
      if (!grouped[area]) {
        grouped[area] = [];
      }
      grouped[area].push(qual);
    });

    return grouped;
  }, [filteredQualifications]);

  // Progression tree structure - showing career paths after GES
  const progressionTree = React.useMemo(() => {
    if (!filteredQualifications) return null;

    const findQual = (achvID) => filteredQualifications.find(q => (q.AchvID || q.achvID) === achvID);

    return {
      foundation: findQual('53'), // GES
      paths: {
        field: {
          title: 'Field Operations',
          description: 'Ground-based field work and search operations',
          qualifications: [
            { qual: findQual('70'), next: ['69', '126'] }, // GTM3 -> GTL, GTM2
            { qual: findQual('71'), next: ['68'] },        // UDF -> GBD
            { qual: findQual('69'), next: ['68', '126'] }, // GTL -> GBD, GTM2
            { qual: findQual('126'), next: ['127'] },      // GTM2 -> GTM1
            { qual: findQual('127'), next: [] },           // GTM1
            { qual: findQual('68'), next: ['64'] },        // GBD -> PSC
            { qual: findQual('258'), next: [] },           // UAS Technician
            { qual: findQual('257'), next: [] },           // UAS Mission Pilot
          ]
        },
        missionBase: {
          title: 'Mission Base Operations',
          description: 'Support operations at the mission base',
          qualifications: [
            { qual: findQual('80'), next: ['72', '66', '78', '77', '75', '65'] }, // MSA -> PIO, FASC, LO, MSO, CUL, LSC
            { qual: findQual('76'), next: ['75'] },        // MRO -> CUL
            { qual: findQual('75'), next: ['65'] },        // CUL -> LSC (requires MSA too)
            { qual: findQual('74'), next: ['73'] },        // FLM -> FLS
            { qual: findQual('73'), next: [] },            // FLS
            { qual: findQual('72'), next: [] },            // PIO
            { qual: findQual('66'), next: [] },            // FASC
            { qual: findQual('78'), next: [] },            // LO
            { qual: findQual('77'), next: [] },            // MSO
            { qual: findQual('65'), next: [] },            // LSC
          ]
        },
        flight: {
          title: 'Flight Operations',
          description: 'Airborne mission operations',
          qualifications: [
            { qual: findQual('55'), next: ['193', '81', '56', '57'] }, // MS -> AP, MO, TMP, MP
            { qual: findQual('193'), next: [] },           // AP
            { qual: findQual('81'), next: ['67'] },        // MO -> AOBD
            { qual: findQual('56'), next: [] },            // TMP
            { qual: findQual('57'), next: [] },            // MP
            { qual: findQual('67'), next: ['64'] },        // AOBD -> PSC
          ]
        },
        leadership: {
          title: 'Advanced Leadership',
          description: 'Incident command and management',
          qualifications: [
            { qual: findQual('64'), next: ['63'] },        // PSC -> OSC
            { qual: findQual('63'), next: ['61'] },        // OSC -> IC3
            { qual: findQual('61'), next: ['125'] },       // IC3 -> IC2
            { qual: findQual('125'), next: ['128'] },      // IC2 -> IC1
            { qual: findQual('128'), next: [] },           // IC1
          ]
        }
      }
    };
  }, [filteredQualifications]);

  // Determine if member has this qualification
  const hasQualification = (achvID) => {
    const quals = member.esQualificationsAll || member.esQualifications || [];
    return quals.some(q =>
      q.achvID === achvID && q.status === 'Active'
    );
  };

  // Render a single qualification node
  const QualNode = ({ qual }) => {
    const achvID = qual.AchvID || qual.achvID;
    const qualName = qual.Achv || qual.name;

    const hasQual = hasQualification(achvID);
    const eligibility = eligibilityMap[achvID];
    const isEligible = eligibility?.eligible ?? true;
    const isSelected = selectedQual && (selectedQual.AchvID === achvID || selectedQual.achvID === achvID);

    let statusClass = '';
    let icon = null;

    if (hasQual) {
      statusClass = 'bg-emerald-100 border-emerald-400 text-emerald-800';
      icon = <Icon name="Check" className="w-4 h-4" />;
    } else if (!isEligible) {
      statusClass = 'bg-slate-100 border-slate-300 text-slate-500 opacity-60';
      icon = <Icon name="Lock" className="w-4 h-4" />;
    } else {
      statusClass = 'bg-white border-slate-300 text-slate-700 hover:border-blue-400';
    }

    if (isSelected) {
      statusClass += ' ring-2 ring-blue-500 ring-offset-2';
    }

    return (
      <div
        className={`p-3 rounded-lg border-2 cursor-pointer transition-all ${statusClass}`}
        onClick={() => setSelectedQual(qual)}
        title={qualName}
      >
        <div className="flex items-center gap-2">
          {icon}
          <div className="flex-1 min-w-0">
            <div className="text-sm font-semibold truncate">{qualName}</div>
            {!isEligible && eligibility && eligibility.reasons && eligibility.reasons.length > 0 && (
              <div className="text-xs text-rose-600 mt-1">
                Missing: {eligibility.reasons.join(', ')}
              </div>
            )}
          </div>
        </div>
      </div>
    );
  };

  // Render a path section in progression view
  const PathSection = ({ title, description, qualifications }) => {
    return (
      <div className="mb-6 p-4 bg-white rounded-lg border-2 border-slate-200">
        <h4 className="text-md font-bold text-slate-800 mb-1">{title}</h4>
        <p className="text-xs text-slate-600 mb-3">{description}</p>
        <div className="grid grid-cols-2 gap-3">
          {qualifications.map(({ qual }, idx) => {
            if (!qual) return null;
            return <QualNode key={idx} qual={qual} />;
          })}
        </div>
      </div>
    );
  };

  return (
    <Modal isOpen={isOpen} onClose={onClose} title="ES Qualification Career Path" maxWidthClass="max-w-6xl">
      {/* View Mode Toggle */}
      <div className="flex gap-2 mb-4">
        <button
          onClick={() => setViewMode('progression')}
          className={`px-4 py-2 rounded-lg text-sm font-semibold transition-colors ${
            viewMode === 'progression'
              ? 'bg-blue-600 text-white'
              : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
          }`}
        >
          Career Progression
        </button>
        <button
          onClick={() => setViewMode('all')}
          className={`px-4 py-2 rounded-lg text-sm font-semibold transition-colors ${
            viewMode === 'all'
              ? 'bg-blue-600 text-white'
              : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
          }`}
        >
          All Qualifications
        </button>
      </div>

      <div className="grid md:grid-cols-3 gap-4">
        {/* Left: Qualification Tree */}
        <div className="md:col-span-2 space-y-4">
          <div className="flex items-center justify-between mb-2">
            <h3 className="text-lg font-bold text-slate-800">
              {viewMode === 'progression' ? 'Your Career Path' : 'Available Qualifications'}
            </h3>
            <div className="flex items-center gap-3 text-xs">
              <div className="flex items-center gap-1">
                <div className="w-3 h-3 rounded bg-emerald-400"></div>
                <span>Active</span>
              </div>
              <div className="flex items-center gap-1">
                <div className="w-3 h-3 rounded bg-slate-300"></div>
                <span>Locked</span>
              </div>
            </div>
          </div>

          {viewMode === 'progression' && progressionTree ? (
            <div className="space-y-4">
              {/* Foundation: GES */}
              <div className="mb-6 p-4 bg-blue-50 rounded-lg border-2 border-blue-300">
                <h4 className="text-md font-bold text-blue-900 mb-2">Foundation</h4>
                <p className="text-xs text-blue-700 mb-3">All ES qualifications require General Emergency Services</p>
                {progressionTree.foundation && <QualNode qual={progressionTree.foundation} />}
              </div>

              {/* Career Paths */}
              {Object.entries(progressionTree.paths).map(([key, path]) => (
                <PathSection
                  key={key}
                  title={path.title}
                  description={path.description}
                  qualifications={path.qualifications}
                />
              ))}
            </div>
          ) : (
            <div className="space-y-6">
              {Object.entries(qualsByArea).map(([area, quals]) => (
                <div key={area} className="space-y-2">
                  <h4 className="text-sm font-bold text-slate-600 uppercase tracking-wide">
                    {ES_FUNCTIONAL_AREAS[area] || area}
                  </h4>
                  <div className="grid grid-cols-2 gap-3">
                    {quals.map(qual => (
                      <QualNode key={qual.AchvID || qual.achvID} qual={qual} />
                    ))}
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>

        {/* Right: Selected Qualification Details */}
        <div className="md:col-span-1">
          {selectedQual ? (
            <div className="sticky top-0 space-y-4">
              <div className="bg-blue-50 p-4 rounded-lg border border-blue-200">
                <h4 className="font-bold text-blue-900 mb-2">{selectedQual.Achv || selectedQual.name}</h4>
                <div className="text-xs text-blue-800 space-y-1">
                  <div>
                    <span className="font-semibold">Area:</span> {ES_FUNCTIONAL_AREAS[selectedQual.FunctionalArea || selectedQual.functionalArea] || selectedQual.FunctionalArea || selectedQual.functionalArea}
                  </div>
                  {(() => {
                    const requiredAge = ES_AGE_REQUIREMENTS[selectedQual.AchvID || selectedQual.achvID];
                    if (requiredAge) {
                      return (
                        <div className="mt-2 pt-2 border-t border-blue-300">
                          <span className="font-semibold">Min Age:</span> {requiredAge} years
                        </div>
                      );
                    }
                  })()}
                </div>
              </div>

              {/* Prerequisites */}
              {(() => {
                const achvID = selectedQual.AchvID || selectedQual.achvID;
                const eligibility = eligibilityMap[achvID];

                // ALWAYS build the prerequisite tree directly, regardless of eligibility
                // This ensures we show the full tree even when special prerequisites (age, tasks) are not met
                const prereqTree = dataService ? dataService.buildESPrerequisiteTree(achvID) : null;
                const hasAchievementPrereqs = prereqTree?.prerequisites?.length > 0;

                // Check if there are missing prerequisites (includes special prereqs from eligibility check)
                const hasMissingPrereqs = eligibility?.reasons && eligibility.reasons.length > 0;

                // Always show prerequisites section
                return (
                  <div className="bg-slate-50 p-4 rounded-lg border border-slate-200">
                    <h5 className="font-semibold text-slate-800 mb-2 text-sm">Prerequisites</h5>

                    {/* Achievement Prerequisites Tree - ALWAYS SHOW if they exist */}
                    {hasAchievementPrereqs && (
                      <div className={hasMissingPrereqs ? "mb-3" : ""}>
                        <PrereqTreeView
                          node={prereqTree}
                          memberQuals={member.esQualificationsAll || member.esQualifications}
                          member={member}
                          dataService={dataService}
                          depth={0}
                          showSelf={false}
                        />
                      </div>
                    )}

                    {/* Missing Prerequisites (from eligibility check - includes tasks, age, etc.) */}
                    {hasMissingPrereqs && (
                      <div>
                        {hasAchievementPrereqs && <div className="border-t border-slate-300 my-2"></div>}
                        <div className="text-xs font-semibold text-slate-600 mb-1">Missing Requirements:</div>
                        <div className="space-y-1">
                          {eligibility.reasons.map((reason, idx) => (
                            <div key={`missing-${idx}`} className="flex items-start gap-2 py-1 text-sm">
                              <Icon name="AlertCircle" className="w-4 h-4 text-rose-600 mt-0.5" />
                              <span className="text-rose-700">{reason}</span>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}

                    {/* No prerequisites message */}
                    {!hasAchievementPrereqs && !hasMissingPrereqs && (
                      <div className="text-sm text-slate-500 italic">
                        No prerequisites required
                      </div>
                    )}

                    {/* All prerequisites met message */}
                    {eligibility?.eligible && (hasAchievementPrereqs || !hasMissingPrereqs) && (
                      <div className="mt-2 pt-2 border-t border-slate-300">
                        <div className="flex items-center gap-2 text-sm text-emerald-700">
                          <Icon name="CheckCircle2" className="w-4 h-4" />
                          <span className="font-medium">All prerequisites met</span>
                        </div>
                      </div>
                    )}
                  </div>
                );
              })()}

              {/* Task Summary */}
              {selectedQualTasks.length > 0 && (
                <div className="bg-slate-50 p-4 rounded-lg border border-slate-200">
                  <h5 className="font-semibold text-slate-800 mb-2 text-sm">Task Requirements</h5>
                  {selectedQualTasks.map((step, idx) => {
                    const stepCompleted = step.tasks.filter(t => t.completed).length;
                    const stepTotal = step.tasks.length;
                    const stepPercent = stepTotal > 0 ? Math.round((stepCompleted / stepTotal) * 100) : 0;

                    return (
                      <div key={idx} className="mb-2">
                        <div className="flex justify-between items-center text-xs">
                          <span className="font-medium text-slate-700">{step.stepName}</span>
                          <span className={`font-semibold ${stepPercent === 100 ? 'text-emerald-600' : 'text-slate-600'}`}>
                            {stepCompleted}/{stepTotal}
                          </span>
                        </div>
                        {stepTotal > 0 && (
                          <div className="w-full bg-slate-200 rounded-full h-1.5 mt-1">
                            <div
                              className={`h-1.5 rounded-full transition-all ${
                                stepPercent === 100 ? 'bg-emerald-500' : 'bg-blue-500'
                              }`}
                              style={{ width: `${stepPercent}%` }}
                            ></div>
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>
              )}

              {selectedQualTasks.length === 0 && (
                <div className="bg-slate-50 p-4 rounded-lg border border-slate-200 text-xs text-slate-500 italic">
                  No specific tasks required for this qualification
                </div>
              )}

              {/* View Full Details Button */}
              <button
                onClick={() => setDetailModalOpen(true)}
                className="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors text-sm font-medium flex items-center justify-center gap-2"
              >
                <Icon name="FileText" className="w-4 h-4" />
                View Full Details
              </button>
            </div>
          ) : (
            <div className="text-sm text-slate-500 italic text-center py-8">
              Select a qualification to view details
            </div>
          )}
        </div>
      </div>

      {/* Full Details Modal - nested modal for viewing complete task requirements */}
      {selectedQual && typeof ESQualificationDetailModal !== 'undefined' && (() => {
        // Get the member's actual qualification object (with completion data)
        // selectedQual is just the achievement definition, we need the member's version
        const achvID = selectedQual.AchvID || selectedQual.achvID;
        const memberQual = (member.esQualificationsAll || member.esQualifications || []).find(q =>
          (q.achvID || q.AchvID) === achvID
        );

        // If member doesn't have this qual yet, create a minimal object for the modal
        const qualForModal = memberQual || {
          achvID: achvID,
          name: selectedQual.Achv || selectedQual.name,
          functionalArea: selectedQual.FunctionalArea || selectedQual.functionalArea,
          status: 'Not Started',
          statusRaw: null,
          completed: null,
          expiration: null
        };

        return (
          <ESQualificationDetailModal
            isOpen={detailModalOpen}
            onClose={() => setDetailModalOpen(false)}
            qualification={qualForModal}
            member={member}
            dataService={dataService}
          />
        );
      })()}
    </Modal>
  );
};
</script>
