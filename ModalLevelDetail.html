<script type="text/babel">
// Level Detail Modal
// Shows detailed breakdown of Education & Training level progress for a member
const LevelDetailModal = ({
  isOpen,
  onClose,
  member,
  level,
  // Helper functions
  getLevelBreakdown,
  // Constants
  LEVEL_DISPLAY_MAP
}) => {
  if (!isOpen || !member || !level) return null;

  const breakdown = getLevelBreakdown(member, level);
  const groups = breakdown?.groups || [];
  const track = breakdown?.track;
  const meta = (member.levelsProgress && member.levelsProgress[level]) || { percent: 0, status: 'not-started' };
  const levelDef = LEVEL_DISPLAY_MAP[level] || { name: `Level ${level}`, label: level };

  const statusLabel = (() => {
    if (meta.status === 'completed') return 'Completed / Awarded';
    if (meta.status === 'pending') return meta.approvalStatus === 'disapproved' ? 'Submitted - Needs Update' : 'Submitted - Pending Approval';
    if (meta.status === 'ready') return 'Ready for Approval';
    if (meta.status === 'in-progress') return 'In Progress';
    return 'Not Started';
  })();

  const statusColor = meta.status === 'completed' ? 'bg-green-50 border-green-200 text-green-800' : (meta.status === 'ready' || meta.status === 'pending') ? 'bg-amber-50 border-amber-200 text-amber-800' : 'bg-slate-50 border-slate-200 text-slate-700';

  return (
    <Modal
      isOpen={isOpen}
      zIndex={60}
      onClose={onClose}
      title={`${member.NameLast} - ${levelDef.name || 'Level Progress'}`}
    >
      <div className="space-y-3">
        <div className={`border rounded-lg p-4 flex items-start justify-between ${statusColor}`}>
          <div>
            <div className="text-xs uppercase tracking-wide font-bold text-slate-500">{levelDef.name}</div>
            <div className="text-lg font-bold mt-1">{statusLabel}</div>
            <div className="text-xs text-slate-600 mt-1">Progress: {meta.percent || 0}%</div>
            {meta.status === 'completed' && meta.date && <div className="text-[11px] text-slate-500 mt-1">Completed: {meta.date}</div>}
            {meta.status === 'ready' && <div className="text-[11px] text-amber-700 font-semibold mt-1">All modules complete. Submit for award.</div>}
            {meta.status === 'pending' && <div className="text-[11px] text-amber-700 font-semibold mt-1">Awaiting approval.</div>}
          </div>
          {(level === 'L2P1' || level === 'L2P2') && (
            <div className="text-right">
              <div className="text-[11px] text-slate-500 uppercase font-bold mb-1">Level 2 Track</div>
              <div className="inline-flex items-center px-2 py-1 rounded-full text-[11px] font-semibold border bg-white">
                {track ? track : 'Not Selected'}
              </div>
            </div>
          )}
        </div>

        {groups.map((g, i) => (
          <div key={i} className="border rounded-lg overflow-hidden shadow-sm">
            <div className={`px-4 py-2.5 text-sm font-bold flex justify-between items-center ${g.isGroupDone ? 'bg-green-50 text-green-800 border-b border-green-100' : 'bg-amber-50 text-amber-800 border-b border-amber-200'}`}>
              <span>{g.groupName}</span>
              <span className="text-xs px-2 py-0.5 bg-white rounded border ml-2">{g.completedCount} / {g.required}</span>
            </div>
            <div className="p-4 bg-white space-y-2">
              {g.tasks.map((t, ti) => (
                <div key={ti} className="flex items-start text-xs group">
                  <div className="mr-3 mt-0.5">
                    {t.isDone ? <CheckCircleFilled /> : <CircleEmpty />}
                  </div>
                  <div>
                    <div className="flex items-center gap-2">
                      <span className={`font-medium ${t.isDone ? "text-slate-900" : "text-slate-600"}`}>{t.TaskName}</span>
                      {(() => {
                        const trackTags = (t.appliesTo || []).filter(tag => tag !== 'ALL');
                        if (!trackTags.length) return null;
                        return (
                          <div className="flex gap-1">
                            {trackTags.map(tag => (
                              <span key={`${t.TaskID}-${tag}`} className="text-[10px] px-1.5 py-0.5 rounded-full bg-slate-100 text-slate-600 border border-slate-200">{tag}</span>
                            ))}
                          </div>
                        );
                      })()}
                    </div>
                    {t.Description && <p className="text-slate-400 mt-0.5 leading-tight">{t.Description}</p>}
                  </div>
                </div>
              ))}
            </div>
          </div>
        ))}
      </div>
    </Modal>
  );
};
</script>
