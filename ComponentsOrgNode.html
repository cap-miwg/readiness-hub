<script type="text/babel">
const OrgNode = ({ node, hideVacant, expandedSections, setExpandedSections, onMemberClick, showCommandChainOnly, onDrillDown }) => {
  if (!node) return null;

  const hasVisibleChildren = (n) => {
    if (!hideVacant) return n.children && n.children.length > 0;
    if (n.members && n.members.length > 0) return true;
    return n.children && n.children.some(c => hasVisibleChildren(c));
  };

  if (hideVacant && !hasVisibleChildren(node) && node.members.length === 0) return null;

  const isCadet = node.type && node.type === 'cadet';
  const colorClass = isCadet ? "bg-slate-700 text-white" : "bg-blue-900 text-white";

  // Command chain positions (only show these when command chain filter is active)
  // Unit level: Commander, Deputies, Cadet Commander and Cadet Deputies, Flight Leadership
  const commandChainIds = [
    'root', 'deputy', 'cds', 'cdc',
    'ccmdr', 'c_dep_ops', 'c_dep_sup', 'c_first',
    'flight_cmdr', 'flight_sgt', 'group_cmdr', 'squadron_cmdr'
  ];

  // Allow dynamic command-chain nodes (unit-specific ids) to appear when expanded
  const commandChainSuffixes = [
    '_deputy', '_cds', '_cdc', '_ccmdr', '_c_dep_ops', '_c_dep_sup', '_c_first', '_flight_cmdr', '_flight_sgt'
  ];

  const isCommandChainNode = (n) => {
    if (!n) return false;
    if (commandChainIds.includes(n.id)) return true;
    // Allow dynamic commander nodes that carry the unit id in the key
    if (n.id.startsWith('group_cmdr_') || n.id.startsWith('squadron_cmdr_')) return true;
    return commandChainSuffixes.some(suffix => n.id.endsWith(suffix));
  };

  let visibleChildren = hideVacant
    ? (node.children || []).filter(c => hasVisibleChildren(c) || c.members.length > 0)
    : (node.children || []);

  // Filter to command chain only if enabled
  if (showCommandChainOnly) {
    visibleChildren = visibleChildren.filter(isCommandChainNode);
  }

  const isCollapsed = expandedSections && !expandedSections.has(node.id);
  const hasChildren = visibleChildren.length > 0;

  const toggleExpand = (e) => {
    e.stopPropagation();
    if (!setExpandedSections || !hasChildren) return;

    // Gather IDs for cadet chain and their parents so the whole chain opens in one click
    const collectCadetIds = (n, ids) => {
      if (!n) return false;
      const isCadetish = n.type === 'cadet' || n.id.startsWith('c_') || n.id.startsWith('flight');
      let hasCadet = isCadetish;
      (n.children || []).forEach(child => {
        if (collectCadetIds(child, ids)) hasCadet = true;
      });
      if (hasCadet) ids.push(n.id);
      return hasCadet;
    };

    setExpandedSections(prev => {
      const newSet = new Set(prev);
      if (newSet.has(node.id)) {
        newSet.delete(node.id);
      } else {
        newSet.add(node.id);
        // When showing command chain, auto-expand cadet chain under this unit
        if (showCommandChainOnly) {
          const cadetIds = [];
          collectCadetIds(node, cadetIds);
          cadetIds.forEach(id => newSet.add(id));
        }
      }
      return newSet;
    });
  };

  const handleMemberClick = (memberName) => {
    if (!onMemberClick) return;
    // Extract CAPID from member string format: "Rank LastName, FirstName"
    // This is a simplified extraction - would need actual CAPID from data
    onMemberClick(memberName);
  };

  // Grouping node: specifically designed to group positions (like "Commander's Staff")
  // Only certain IDs are true grouping nodes, not just any vacant position with children
  const isGroupingNode = node.id === 'commander_staff';

  return (
    <div className="flex flex-col items-center mx-2 my-1">
      <div className="relative border-2 rounded-lg shadow-lg mb-3 p-0 w-56 bg-white z-10 hover:shadow-xl transition-shadow">
        <div className={`${colorClass} px-3 py-2 text-center text-xs font-bold uppercase ${isGroupingNode ? 'rounded-md' : 'rounded-t-md'} flex items-center justify-center gap-1`} title={node.title}>
          {onDrillDown && (
            <button
              onClick={(e) => {
                e.stopPropagation();
                onDrillDown(node);
              }}
              className="text-white hover:bg-black hover:bg-opacity-20 rounded p-1 transition-colors"
              title="View across all sub-units"
            >
              <svg className="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                <path fillRule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clipRule="evenodd"/>
              </svg>
            </button>
          )}
          <span className="flex-1 text-center leading-tight whitespace-normal">{node.title}</span>
          {hasChildren && (
            <button
              onClick={toggleExpand}
              className="text-white hover:bg-black hover:bg-opacity-20 rounded px-1.5 py-0.5 transition-colors"
              title={isCollapsed ? "Expand" : "Collapse"}
            >
              {isCollapsed ? '>' : 'v'}
            </button>
          )}
        </div>
        {/* Only show white body section if not a grouping node */}
        {!isGroupingNode && (
          <div className="p-2 min-h-[40px] flex flex-col justify-center bg-white rounded-b-md">
            {node.members && node.members.length > 0 ? (
              node.members.map((m,i) => {
                const display = m.includes('||') ? m.split('||')[0] : m;
                return (
                  <div
                    key={i}
                    className="text-xs font-medium text-slate-800 border-b last:border-0 border-slate-100 py-1 px-1 hover:bg-blue-50 cursor-pointer transition-colors rounded"
                    onClick={() => handleMemberClick(m)}
                    title="Click to view profile"
                  >
                    {display}
                  </div>
                );
              })
            ) : (
              <span className="text-[11px] uppercase font-bold text-amber-700 bg-amber-50 border border-amber-200 rounded px-2 py-1 text-center">Vacant</span>
            )}
          </div>
        )}
      </div>

      {hasChildren && !isCollapsed && (
        <div className="relative w-full flex flex-col items-center">
          <div className="w-0.5 h-4 bg-slate-400"></div>
          <div className="relative flex justify-center items-start gap-2">
            {visibleChildren.length > 1 && (
              <div className="absolute top-0 left-0 right-0 h-0.5 bg-slate-400" style={{width: '100%'}}></div>
            )}
            {visibleChildren.map(c => (
              <div key={c.id} className="relative flex flex-col items-center">
                {visibleChildren.length > 1 && <div className="w-0.5 h-4 bg-slate-400"></div>}
                <OrgNode node={c} hideVacant={hideVacant} expandedSections={expandedSections} setExpandedSections={setExpandedSections} onMemberClick={onMemberClick} showCommandChainOnly={showCommandChainOnly} onDrillDown={onDrillDown} />
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  );
};

</script>
