<script type="text/babel">
class ErrorBoundary extends React.Component {
  constructor(props) { super(props); this.state = { hasError: false, error: null }; }
  static getDerivedStateFromError(error) { return { hasError: true, error }; }
  componentDidCatch(error, errorInfo) {
    // Log to console for debugging, but don't expose to users
    console.error('Application Error:', error, errorInfo);
  }
  render() {
    if (this.state.hasError) {
      return (
        <div className="p-8 bg-red-50 text-red-900 h-screen flex flex-col items-center justify-center text-center">
          <h1 className="text-2xl font-bold mb-4">Application Error</h1>
          <p className="mb-4">Something went wrong while rendering the dashboard.</p>
          <p className="text-sm text-red-600 mb-4">Please try refreshing the page. If the problem persists, clear your browser cache.</p>
          <button onClick={() => window.location.reload()} className="mt-6 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Reload Page</button>
        </div>
      );
    }
    return this.props.children;
  }
}

const Icon = ({ name, className, ...props }) => {
  const lib = window.lucideReact || window.LucideReact || window.lucide;
  let LucideIcon = lib ? lib[name] : null;

  // Try alternate names for common icons
  if (!LucideIcon && name === 'HelpCircle') LucideIcon = lib?.['CircleHelp'];
  if (!LucideIcon && name === 'CircleHelp') LucideIcon = lib?.['HelpCircle'];

  // Fallback for missing icons
  if (!LucideIcon) {
    if (name === 'X') return <span className={`font-bold ${className}`}>X</span>;
    if (name === 'HelpCircle' || name === 'CircleHelp') {
      // Hardcoded HelpCircle SVG fallback
      return (
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
          <circle cx="12" cy="12" r="10"/>
          <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
          <path d="M12 17h.01"/>
        </svg>
      );
    }
    return null;
  }
  return <LucideIcon className={className} {...props} />;
};

// --- HARDCODED SVGs FOR CRITICAL UI ELEMENTS (To avoid library failures) ---
const WarningTriangle = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-amber-500 mr-1.5"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></svg>
);

const CheckCircleFilled = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" className="text-green-500 mr-2"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
);

const CircleEmpty = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="text-slate-300 mr-2"><circle cx="12" cy="12" r="10"/></svg>
);

  const Badge = ({ children, color = "blue", warning, isRed = false, title, ...props }) => {
    let colors = { blue: "bg-blue-100 text-blue-800 border-blue-200", green: "bg-green-100 text-green-800 border-green-200", gray: "bg-slate-100 text-slate-800 border-slate-200", red: "bg-red-100 text-red-800 border-red-200", amber: "bg-amber-100 text-amber-800 border-amber-200" };
    if (isRed) colors[color] = "bg-slate-100 text-red-600 border-slate-200 font-bold";

  return (
    <span className={`flex items-center px-2.5 py-0.5 rounded border text-xs font-medium cursor-help whitespace-nowrap ${colors[color] || colors.blue}`} title={title} {...props}>
      {children}
      {warning && <WarningTriangle />}
    </span>
  );
};

const ESBadge = ({ qualification, onClick, size = 'normal', showStatus = false }) => {
  const { name, status, colorClass, isSkillsEvaluator, isExpiringSoon } = qualification;

  // Size variants
  const sizeClasses = {
    small: 'px-2 py-0.5 text-[10px]',
    normal: 'px-2.5 py-1 text-xs',
    large: 'px-3 py-1.5 text-sm'
  };

  // Color mapping - with support for expiring soon (green background with amber border)
  // SET-rated qualifications get thicker border (border-3)
  const colors = {
    'es-active': isExpiringSoon
      ? 'bg-emerald-100 text-emerald-800 border-amber-400 border-2 hover:bg-emerald-200'
      : isSkillsEvaluator
        ? 'bg-emerald-100 text-emerald-800 border-emerald-400 border-[3px] hover:bg-emerald-200'
        : 'bg-emerald-100 text-emerald-800 border-emerald-300 hover:bg-emerald-200',
    'es-training': 'bg-amber-100 text-amber-800 border-amber-300 hover:bg-amber-200',
    'es-expired': 'bg-rose-100 text-rose-800 border-rose-300 hover:bg-rose-200',
    'es-not-approved': 'bg-slate-100 text-slate-600 border-slate-300 hover:bg-slate-200'
  };

  // Extract acronym from name (except for CAP Drivers License and OPSEC which show full name)
  const getDisplayName = (fullName) => {
    // Keep full name for CAP Drivers License and OPSEC
    if (fullName.includes('CAP Drivers License') || fullName === 'OPSEC') {
      return fullName;
    }

    // Extract acronym (text before the first dash and hyphen)
    const dashIndex = fullName.indexOf(' - ');
    if (dashIndex > 0) {
      return fullName.substring(0, dashIndex).trim();
    }

    // If no dash found, return the full name
    return fullName;
  };

  const title = `${name} - ${status}${isSkillsEvaluator ? ' (SET Rated)' : ''}`;
  const displayText = showStatus ? status : getDisplayName(name);

  return (
    <span
      className={`inline-flex items-center gap-1 rounded border font-medium cursor-pointer transition-colors ${sizeClasses[size]} ${colors[colorClass]}`}
      onClick={onClick}
      title={title}
    >
      {isSkillsEvaluator && (
        <Icon name="Star" className="w-3 h-3 fill-current" />
      )}
      <span className={`truncate max-w-[120px] ${showStatus ? 'uppercase' : ''}`}>{displayText}</span>
    </span>
  );
};

const Modal = ({ isOpen, onClose, title, children, zIndex = 50, maxWidthClass = "max-w-4xl" }) => {
  if (!isOpen) return null;
  return (
    <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 p-4" style={{ zIndex }} onClick={onClose}>
      <div className={`bg-white rounded-lg shadow-xl w-full ${maxWidthClass} max-h-[90vh] flex flex-col`} onClick={(e) => e.stopPropagation()}>
        <div className="flex justify-between items-center p-6 border-b border-slate-200">
          <h2 className="text-xl font-bold text-slate-900">{title}</h2>
          <button onClick={onClose} className="text-slate-400 hover:text-slate-600 p-2"><Icon name="X" className="w-6 h-6" /></button>
        </div>
        <div className="p-6 overflow-y-auto">{children}</div>
      </div>
    </div>
  );
};

/**
 * DashboardSection - Collapsible accordion section for Unit Overview
 *
 * Props:
 * - id: string - unique section identifier
 * - title: string - section header
 * - icon: string - Lucide icon name
 * - isExpanded: boolean - current expansion state
 * - onToggle: function - called when section is clicked
 * - onDeepDive: function - called when "View Details" button clicked
 * - keyData: ReactNode - content to show when collapsed
 * - children: ReactNode - content to show when expanded
 * - accentColor: string - 'blue' | 'green' | 'amber' | 'indigo' | 'rose'
 */
const DashboardSection = ({
  id,
  title,
  icon,
  isExpanded,
  onToggle,
  onDeepDive,
  keyData,
  children,
  accentColor = 'blue'
}) => {
  const accentStyles = {
    blue: {
      border: 'border-blue-200',
      headerBg: 'bg-blue-50',
      iconBg: 'bg-blue-100',
      iconText: 'text-blue-600',
      expandedBorder: 'border-blue-300'
    },
    green: {
      border: 'border-emerald-200',
      headerBg: 'bg-emerald-50',
      iconBg: 'bg-emerald-100',
      iconText: 'text-emerald-600',
      expandedBorder: 'border-emerald-300'
    },
    amber: {
      border: 'border-amber-200',
      headerBg: 'bg-amber-50',
      iconBg: 'bg-amber-100',
      iconText: 'text-amber-600',
      expandedBorder: 'border-amber-300'
    },
    indigo: {
      border: 'border-indigo-200',
      headerBg: 'bg-indigo-50',
      iconBg: 'bg-indigo-100',
      iconText: 'text-indigo-600',
      expandedBorder: 'border-indigo-300'
    },
    rose: {
      border: 'border-rose-200',
      headerBg: 'bg-rose-50',
      iconBg: 'bg-rose-100',
      iconText: 'text-rose-600',
      expandedBorder: 'border-rose-300'
    }
  };

  const styles = accentStyles[accentColor] || accentStyles.blue;

  return (
    <div className={`bg-white rounded-xl border shadow-sm overflow-hidden transition-all duration-200 ${
      isExpanded ? styles.expandedBorder : styles.border
    }`}>
      {/* Header - always visible, clickable */}
      <button
        onClick={() => onToggle(id)}
        className={`w-full p-4 flex items-center justify-between gap-4 text-left hover:bg-slate-50 transition-colors ${
          isExpanded ? styles.headerBg : ''
        }`}
      >
        <div className="flex items-center gap-3">
          <div className={`w-10 h-10 rounded-lg ${styles.iconBg} ${styles.iconText} flex items-center justify-center shrink-0`}>
            <Icon name={icon} className="w-5 h-5" />
          </div>
          <div>
            <h3 className="font-bold text-lg text-slate-800">{title}</h3>
            {!isExpanded && keyData && (
              <div className="text-sm text-slate-600 mt-0.5">{keyData}</div>
            )}
          </div>
        </div>
        <div className="flex items-center gap-2">
          {onDeepDive && (
            <span
              onClick={(e) => { e.stopPropagation(); onDeepDive(id); }}
              className="px-3 py-1.5 text-sm font-medium text-blue-600 hover:text-blue-700 hover:bg-blue-50 rounded-lg transition-colors cursor-pointer"
            >
              View Details
            </span>
          )}
          <Icon
            name={isExpanded ? 'ChevronUp' : 'ChevronDown'}
            className="w-5 h-5 text-slate-400"
          />
        </div>
      </button>

      {/* Expanded content */}
      {isExpanded && (
        <div className="p-4 pt-0 border-t border-slate-100">
          {children}
        </div>
      )}
    </div>
  );
};

/**
 * KeyMetricCard - Compact metric display for collapsed section view
 */
const KeyMetricCard = ({ label, value, subValue, trend, trendDirection, color = 'blue' }) => {
  const colorStyles = {
    blue: 'bg-blue-50 border-blue-100',
    green: 'bg-emerald-50 border-emerald-100',
    amber: 'bg-amber-50 border-amber-100',
    red: 'bg-rose-50 border-rose-100',
    slate: 'bg-slate-50 border-slate-100'
  };

  const trendColors = {
    up: 'text-emerald-600',
    down: 'text-rose-600',
    stable: 'text-slate-500'
  };

  return (
    <div className={`px-3 py-2 rounded-lg border ${colorStyles[color] || colorStyles.blue}`}>
      <div className="text-[10px] uppercase font-bold text-slate-500 tracking-wide">{label}</div>
      <div className="flex items-baseline gap-2">
        <span className="text-xl font-bold text-slate-800">{value}</span>
        {trend && (
          <span className={`text-xs font-medium ${trendColors[trendDirection] || trendColors.stable}`}>
            {trendDirection === 'up' && '+'}
            {trend}
          </span>
        )}
      </div>
      {subValue && <div className="text-xs text-slate-500">{subValue}</div>}
    </div>
  );
};

/**
 * SustainabilityGauge - Visual indicator for sustainability score
 */
const SustainabilityGauge = ({ score, rating }) => {
  const ratingStyles = {
    'excellent': { color: 'text-emerald-600', bg: 'bg-emerald-500', label: 'Excellent' },
    'good': { color: 'text-blue-600', bg: 'bg-blue-500', label: 'Good' },
    'fair': { color: 'text-amber-600', bg: 'bg-amber-500', label: 'Fair' },
    'needs-attention': { color: 'text-rose-600', bg: 'bg-rose-500', label: 'Needs Attention' },
    'unknown': { color: 'text-slate-500', bg: 'bg-slate-400', label: 'Insufficient Data' }
  };

  const style = ratingStyles[rating] || ratingStyles.unknown;

  return (
    <div className="flex items-center gap-3">
      <div className="flex-1">
        <div className="h-2 bg-slate-100 rounded-full overflow-hidden">
          <div
            className={`h-full ${style.bg} transition-all duration-500`}
            style={{ width: `${score || 0}%` }}
          />
        </div>
      </div>
      <div className={`text-sm font-semibold ${style.color}`}>
        {score !== null && score !== undefined ? `${score}%` : '--'}
      </div>
      <div className={`text-xs font-medium px-2 py-0.5 rounded-full ${style.bg} text-white`}>
        {style.label}
      </div>
    </div>
  );
};
</script>
